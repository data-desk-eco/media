<!doctype html>
<notebook theme="midnight">
  <title>Data Desk media mentions</title>
  <script id="header" type="text/markdown">
    # Media mentions

    Reports featuring Data Desk research and analysis.
  </script>
  <script id="mentions" output="mentions" type="application/sql" database="../data/data.duckdb" hidden>
    SELECT * FROM mentions ORDER BY published DESC
  </script>
  <script id="main" type="module">

    // Process data for the chart - group by quarter
    const mentionsByQuarter = d3.rollup(
      mentions,
      v => v.length,
      d => {
        const date = new Date(d.published);
        const year = date.getFullYear();
        const quarter = Math.floor(date.getMonth() / 3);
        // Create date string in YYYY-MM-DD format for the first day of quarter
        const month = String(quarter * 3 + 1).padStart(2, '0');
        return `${year}-${month}-01`;
      }
    );

    const chartData = Array.from(mentionsByQuarter, ([dateStr, count]) => ({
      date: new Date(dateStr),
      count
    })).sort((a, b) => a.date - b.date);

    // Display the bar chart
    display(Plot.plot({
      height: 150,
      marginLeft: 18,
      marginBottom: 40,
      x: {
        type: "utc",
        label: null,
        tickFormat: (d, i, ticks) => {
          const quarter = Math.floor(d.getMonth() / 3) + 1;
          const year = d.getFullYear();
          const prevYear = i > 0 ? ticks[i - 1].getFullYear() : null;

          if (year === 2022) {
            return `Q${quarter}`;
          }
          if (quarter === 1 || prevYear !== year) {
            return `Q${quarter}\n${year}`;
          }
          return `Q${quarter}`;
        }
      },
      y: {
        label: null,
        grid: true
      },
      marks: [
        Plot.rectY(chartData, {
          x: "date",
          y: "count",
          interval: d3.utcMonth.every(3),
          fill: "var(--theme-foreground)",
          tip: true
        }),
        Plot.ruleY([0])
      ]
    }));


    display(html`<ul style="list-style: none; padding-left: 0;">
      ${mentions.map(m => {
        const date = new Date(m.published).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        return html`<li style="margin: 1rem 0;">
          <div><a href="${m.url}" target="_blank">${m.title}</a></div>
          <div style="color: #888; font-size: 0.9em;">${m.source} / ${date}</div>
        </li>`;
      })}
    </ul>`);
  </script>
</notebook>
